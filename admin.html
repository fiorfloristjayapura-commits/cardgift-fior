<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - FIOR Card Generator</title>

<style>
body{
    background:#111;
    color:white;
    font-family:Arial, sans-serif;
    padding:30px;
}
.container{
    max-width:600px;
    margin:auto;
}
input, textarea, select, button{
    width:100%;
    padding:12px;
    margin:10px 0;
    border-radius:8px;
    border:none;
    font-size:16px;
}
button{
    background:gold;
    color:black;
    font-weight:bold;
    cursor:pointer;
}
#result{
    margin-top:20px;
    background:#222;
    padding:15px;
    border-radius:8px;
    word-break:break-all;
}
</style>
</head>

<body>
<div class="container">
    <h2>FIOR Card Generator</h2>

    <input id="recipientName" placeholder="Nama penerima">

    <input id="whatsappNumber" placeholder="Nomor WhatsApp">

    <textarea id="cardMessage" placeholder="Pesan ucapan"></textarea>

    <select id="selectedTheme">
        <option value="birthday">Birthday</option>
        <option value="valentine">Valentine</option>
        <option value="wedding">Wedding</option>
        <option value="anniversary">Anniversary</option>
        <option value="graduation">Graduation</option>
        <option value="condolence">Condolence</option>
    </select>

    <input type="file" id="mediaUpload">

    <button onclick="createCard()">Generate Card</button>

    <div id="result"></div>
</div>

<script>
const CONFIG = {
    SCRIPT_URL: "https://script.google.com/macros/s/AKfycbz2LJYVbyVkfsq3SKpczvnckcmir55jDijhUL6Bbm1GDfjEbBQgZ6DYb_6MI8kMsw6wCA/exec",
    CARD_BASE_URL: "card.html"
};

let uploadedMedia = null;

document.getElementById("mediaUpload").addEventListener("change", e=>{
    uploadedMedia = e.target.files[0] || null;
});

async function createCard(){
    const name = document.getElementById("recipientName").value;
    const phone = document.getElementById("whatsappNumber").value;
    const message = document.getElementById("cardMessage").value;
    const theme = document.getElementById("selectedTheme").value;

    if(!name || !phone || !message){
        alert("Lengkapi data dulu");
        return;
    }

    let mediaUrl = "";

    if(uploadedMedia){
        try{
            mediaUrl = await uploadToGoogleDrive(uploadedMedia);
        }catch(e){
            alert("Upload media gagal");
        }
    }

    let cardUrl =
        `${CONFIG.CARD_BASE_URL}?to=${encodeURIComponent(name)}`
        + `&msg=${encodeURIComponent(message)}`
        + `&theme=${theme}`;

    if(mediaUrl){
        cardUrl += `&media=${encodeURIComponent(mediaUrl)}`;
    }

    document.getElementById("result").innerHTML =
        `<a href="${cardUrl}" target="_blank">${cardUrl}</a>`;

    // save to sheet
    await fetch(CONFIG.SCRIPT_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            type:"card",
            nama:name,
            tema:theme,
            pesan:message,
            link:cardUrl,
            media_url:mediaUrl
        })
    });
}

async function uploadToGoogleDrive(file, progressCallback = null) {
    try {
        const base64Data = await fileToBase64(file);

        const payload = {
            type: "media",
            filename: file.name,
            mimeType: file.type,
            data: base64Data.split(',')[1]
        };

        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error("Server tidak merespon");
        }

        const result = await response.json();

        if (result.status === "success" && result.url) {
            return result.url;
        } else {
            throw new Error(result.message || "Upload gagal");
        }

    } catch (error) {
        console.error("Upload error:", error);
        throw new Error("Upload gagal: " + error.message);
    }
}

function fileToBase64(file){
    return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = ()=>resolve(reader.result);
        reader.onerror = reject;
    });
}
</script>
</body>
</html>
