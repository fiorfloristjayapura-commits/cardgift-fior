<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIOR Card - Admin Panel</title>
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <style>
        /* CSS tetap sama seperti di atas - tidak diubah */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --navy: #1e3a5f; --navy-light: #2b4c73; --navy-deep: #0a192f;
            --gold: #d4af37; --gold-light: #f5e8c6; --white: #ffffff;
            --soft-white: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0;
            --gray-300: #cbd5e1; --gray-600: #475569; --gray-800: #1e293b;
            --success: #0f766e; --success-light: #d1fae5; --danger: #b91c1c;
            --danger-light: #fee2e2; --warning: #b45309; --warning-light: #ffedd5;
            --coral: #ff7f50; --info: #0284c7; --info-light: #e0f2fe;
            --purple: #7c3aed; --purple-light: #ede9fe;
            
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05);
            
            --radius-md: 0.5rem; --radius-lg: 0.75rem; --radius-xl: 1rem; --radius-full: 9999px;
            --transition: all 0.3s ease;
        }

        body { font-family: 'Inter', sans-serif; background: var(--soft-white); color: var(--gray-800); }

        .header {
            background: var(--white); border-bottom: 1px solid var(--gray-200);
            padding: 1rem 2rem; display: flex; justify-content: space-between;
            align-items: center; position: sticky; top: 0; z-index: 50; box-shadow: var(--shadow-sm);
        }

        .logo { display: flex; align-items: center; gap: 1.25rem; }
        .logo-image {
            width: 50px; height: 50px;
            background-image: url('https://raw.githubusercontent.com/fiorfloristjayapura-commits/cardgift-fior/d7415aa463679a5ce6f358244c536824fb4c278c/logo%20fior%20transparant.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            filter: drop-shadow(0 4px 6px rgba(212,175,55,0.2));
            animation: gentleFloat 4s ease-in-out infinite;
        }
        @keyframes gentleFloat { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .logo-text { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 800; color: var(--navy-deep); }
        .logo-text span { color: var(--gold); }

        .datetime {
            background: linear-gradient(145deg, var(--gray-100), var(--white));
            padding: 0.6rem 1.5rem; border-radius: 50px; border: 1px solid var(--gray-200);
            color: var(--navy); font-weight: 600; font-size: 0.95rem; box-shadow: var(--shadow-sm);
            display: flex; align-items: center; gap: 0.5rem;
        }

        .container { display: flex; min-height: calc(100vh - 82px); }

        .sidebar {
            width: 280px; background: var(--white); border-right: 1px solid var(--gray-200);
            padding: 2rem 1.25rem; position: sticky; top: 82px; height: calc(100vh - 82px); overflow-y: auto;
        }
        .sidebar-header { display: flex; align-items: center; gap: 0.75rem; padding: 0 0.5rem 1.5rem 0.5rem; border-bottom: 1px solid var(--gray-200); margin-bottom: 1.5rem; }
        .sidebar-logo { width: 40px; height: 40px; background-image: url('https://raw.githubusercontent.com/fiorfloristjayapura-commits/cardgift-fior/d7415aa463679a5ce6f358244c536824fb4c278c/logo%20fior%20transparant.png'); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .sidebar-title { font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 700; color: var(--navy); }

        .nav-item {
            display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1.25rem;
            color: var(--gray-600); border-radius: var(--radius-lg); margin-bottom: 0.25rem;
            cursor: pointer; transition: var(--transition); font-weight: 500;
        }
        .nav-item i { width: 24px; color: var(--gray-400); }
        .nav-item:hover { background: var(--gold-light); color: var(--navy); }
        .nav-item:hover i { color: var(--gold); }
        .nav-item.active { background: linear-gradient(145deg, var(--navy), var(--navy-light)); color: white; }
        .nav-item.active i { color: white; }

        .status {
            margin-top: 2rem; padding: 1.25rem; background: linear-gradient(145deg, var(--soft-white), var(--white));
            border-radius: var(--radius-lg); border: 1px solid var(--gray-200);
            display: flex; align-items: center; gap: 0.75rem;
        }
        .status-dot { width: 10px; height: 10px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; }
        .status-dot.offline { background: var(--danger); }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        .status-text { font-weight: 600; color: var(--success); }
        .status-text.offline { color: var(--danger); }

        .main-content { flex: 1; padding: 2.5rem; overflow-y: auto; }

        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-title {
            font-family: 'Playfair Display', serif; font-size: 2.2rem; font-weight: 800;
            color: var(--navy-deep); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem;
        }
        .page-title i { color: var(--gold); font-size: 2rem; }

        .page-subtitle {
            color: var(--gray-600); font-size: 1rem; margin-bottom: 2rem;
            padding-left: 0.5rem; border-left: 3px solid var(--gold);
        }

        .form-card {
            background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-xl);
            padding: 2.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-md); position: relative; overflow: hidden;
        }
        .form-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: linear-gradient(to bottom, var(--gold), var(--navy));
        }

        .form-group { margin-bottom: 1.75rem; }
        .form-label {
            display: block; margin-bottom: 0.6rem; font-weight: 600; color: var(--navy);
            display: flex; align-items: center; gap: 0.5rem; font-size: 0.95rem;
        }
        .form-label i { color: var(--gold); width: 20px; }

        .form-control {
            width: 100%; padding: 0.875rem 1.25rem; background: var(--soft-white);
            border: 1px solid var(--gray-300); border-radius: var(--radius-lg);
            color: var(--gray-800); font-size: 0.95rem; transition: var(--transition);
            font-family: 'Inter', sans-serif;
        }
        .form-control:focus {
            outline: none; border-color: var(--gold); background: var(--white);
            box-shadow: 0 0 0 4px rgba(212,175,55,0.1);
        }
        textarea.form-control { min-height: 120px; resize: vertical; }

        .expiry-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 0.5rem; }
        .expiry-card {
            background: var(--white); border: 2px solid var(--gray-200); border-radius: var(--radius-lg);
            padding: 1.5rem 1rem; text-align: center; cursor: pointer; transition: var(--transition);
        }
        .expiry-card:hover { border-color: var(--gold); transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .expiry-card.selected { border-color: var(--gold); background: linear-gradient(145deg, #fff9f0, var(--gold-light)); }
        .expiry-icon {
            width: 56px; height: 56px; background: var(--gold-light); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;
            color: var(--navy); font-size: 1.5rem; transition: var(--transition);
        }
        .expiry-card.selected .expiry-icon { background: var(--gold); color: white; }
        .expiry-value { font-size: 1.8rem; font-weight: 700; color: var(--navy); line-height: 1.2; margin-bottom: 0.25rem; }
        .expiry-label { font-size: 0.85rem; color: var(--gray-600); margin-bottom: 0.75rem; }
        .expiry-badge {
            display: inline-block; padding: 0.25rem 0.75rem; background: var(--gray-100);
            border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600; color: var(--gray-600);
        }
        .expiry-card.selected .expiry-badge { background: var(--gold); color: var(--navy); }
        .expiry-badge.permanent { background: var(--purple-light); color: var(--purple); }

        .url-media-section {
            background: linear-gradient(145deg, var(--soft-white), var(--white));
            border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.5rem;
            border: 1px solid var(--gray-200);
        }
        .url-media-header {
            display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;
            color: var(--navy); font-weight: 600; font-size: 1rem;
            padding-bottom: 0.75rem; border-bottom: 2px solid var(--gold-light);
        }
        .url-media-header i { color: var(--gold); font-size: 1.2rem; }
        .url-media-badge {
            background: var(--gold); color: var(--navy); padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem;
        }
        .url-media-grid { display: grid; grid-template-columns: 1fr auto; gap: 0.75rem; margin-bottom: 1rem; }
        .url-media-input-group { display: flex; gap: 0.75rem; width: 100%; }
        .url-media-input {
            flex: 1; padding: 0.875rem 1.25rem; background: var(--white);
            border: 2px solid var(--gray-200); border-radius: var(--radius-lg); font-size: 0.95rem; transition: var(--transition);
        }
        .url-media-input:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 0 4px rgba(212,175,55,0.1); }
        .url-media-type {
            padding: 0.875rem 1.25rem; background: var(--white); border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg); color: var(--gray-600); font-size: 0.95rem; cursor: pointer;
        }
        .btn-add-media {
            padding: 0.875rem 2rem; background: var(--navy); color: white; border: none;
            border-radius: var(--radius-lg); font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 0.75rem;
            transition: var(--transition); white-space: nowrap;
        }
        .btn-add-media:hover:not(:disabled) { background: var(--navy-light); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-add-media:disabled { opacity: 0.5; cursor: not-allowed; }

        .media-list {
            display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem;
            max-height: 300px; overflow-y: auto; padding-right: 0.5rem;
        }
        .media-item {
            display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem;
            background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-lg);
            animation: slideIn 0.3s ease; transition: var(--transition); box-shadow: var(--shadow-sm);
        }
        .media-item:hover { border-color: var(--gold); transform: translateX(5px); box-shadow: var(--shadow-md); }
        .media-icon {
            width: 40px; height: 40px; background: var(--gold-light); border-radius: var(--radius-lg);
            display: flex; align-items: center; justify-content: center; color: var(--navy); font-size: 1.2rem;
        }
        .media-details { flex: 1; }
        .media-url { font-size: 0.85rem; color: var(--gray-600); word-break: break-all; margin-bottom: 0.25rem; font-family: monospace; }
        .media-type-badge {
            display: inline-block; padding: 0.25rem 0.75rem; background: var(--navy); color: white;
            border-radius: var(--radius-full); font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
        }
        .media-type-badge.video { background: var(--coral); }
        .media-actions { display: flex; gap: 0.5rem; }
        .btn-media-remove {
            padding: 0.5rem 1rem; background: var(--danger-light); color: var(--danger);
            border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 0.85rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .btn-media-preview {
            padding: 0.5rem 1rem; background: var(--gray-100); color: var(--gray-600);
            border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 0.85rem;
            display: flex; align-items: center; gap: 0.5rem;
        }

        .theme-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem; margin-top: 0.5rem;
        }
        .theme-card {
            background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-lg);
            padding: 1.25rem 0.5rem; text-align: center; cursor: pointer; transition: var(--transition);
        }
        .theme-card:hover { border-color: var(--gold); background: var(--gold-light); transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .theme-card.active { background: linear-gradient(145deg, var(--navy), var(--navy-light)); border-color: var(--navy); }
        .theme-card.active .theme-emoji, .theme-card.active .theme-name { color: white; }
        .theme-emoji { font-size: 2.2rem; margin-bottom: 0.5rem; }
        .theme-name { font-size: 0.8rem; font-weight: 600; color: var(--gray-700); }

        .btn {
            padding: 0.875rem 1.75rem; border: none; border-radius: var(--radius-lg);
            font-weight: 600; cursor: pointer; display: inline-flex; align-items: center;
            justify-content: center; gap: 0.75rem; transition: var(--transition); font-size: 0.95rem;
        }
        .btn-primary { background: linear-gradient(145deg, var(--navy), var(--navy-light)); color: white; box-shadow: var(--shadow-md); }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .btn-success { background: linear-gradient(145deg, var(--success), #0a5c4c); color: white; }
        .btn-info { background: linear-gradient(145deg, var(--info), #0369a1); color: white; }
        .btn-purple { background: linear-gradient(145deg, var(--purple), #6d28d9); color: white; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }

        .result-card {
            background: var(--white); border: 1px solid var(--success); border-radius: var(--radius-xl);
            padding: 2.5rem; margin-top: 2rem; display: none; position: relative; overflow: hidden;
            box-shadow: var(--shadow-lg); animation: slideInUp 0.4s ease;
        }
        .result-card.active { display: block !important; }
        .link-container {
            display: flex; align-items: center; gap: 1rem; background: var(--soft-white);
            padding: 1rem 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--gray-200);
            margin: 1.5rem 0;
        }
        .short-link { flex: 1; color: var(--navy); word-break: break-all; font-family: monospace; font-size: 0.95rem; }
        .copy-btn {
            background: var(--navy); color: white; border: none; padding: 0.5rem 1.25rem;
            border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); font-weight: 500;
        }
        .qrcode-container {
            display: flex; justify-content: center; margin: 1.5rem 0; padding: 1.5rem;
            background: linear-gradient(145deg, var(--white), var(--soft-white));
            border-radius: var(--radius-lg); border: 1px solid var(--gray-200);
        }
        .qrcode-container img { border-radius: var(--radius-md); box-shadow: var(--shadow-md); }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem; margin: 1.5rem 0;
        }
        .stat-card {
            background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-lg);
            padding: 1.5rem 1rem; text-align: center; box-shadow: var(--shadow-sm);
        }
        .stat-icon {
            width: 48px; height: 48px; background: var(--gold-light); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;
            color: var(--navy); font-size: 1.2rem;
        }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--navy); line-height: 1.2; }
        .stat-label { font-size: 0.8rem; color: var(--gray-600); text-transform: uppercase; }

        .table-container {
            background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-xl);
            overflow: auto; max-height: 500px; box-shadow: var(--shadow-md);
        }
        .table { width: 100%; border-collapse: collapse; }
        .table th {
            background: linear-gradient(145deg, var(--gray-100), var(--white));
            color: var(--navy); font-weight: 600; padding: 1rem 1.25rem; text-align: left;
            border-bottom: 2px solid var(--gray-200); position: sticky; top: 0; z-index: 10;
        }
        .table td { padding: 1rem 1.25rem; border-bottom: 1px solid var(--gray-200); color: var(--gray-700); }
        .expiry-status {
            display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-full);
            font-size: 0.75rem; font-weight: 600;
        }
        .expiry-status.active { background: var(--success-light); color: var(--success); }
        .expiry-status.permanent { background: var(--purple-light); color: var(--purple); }

        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 9999;
        }
        .loading-content { text-align: center; background: white; padding: 2.5rem; border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); }
        .loading-spinner {
            width: 60px; height: 60px; border: 4px solid var(--gold-light); border-top-color: var(--gold);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .alert {
            padding: 1rem 1.75rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;
            display: none; animation: slideInRight 0.3s ease; border-left: 4px solid; font-weight: 500;
        }
        .alert-success { background: var(--success-light); border-color: var(--success); color: var(--success); }
        .alert-error { background: var(--danger-light); border-color: var(--danger); color: var(--danger); }
        .alert-info { background: var(--info-light); border-color: var(--info); color: var(--info); }

        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            justify-content: center; align-items: center; z-index: 1000; padding: 1rem;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--white); border-radius: var(--radius-xl); max-width: 550px; width: 100%;
            max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative;
            box-shadow: var(--shadow-xl); border: 1px solid var(--gray-200);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--gray-200);
        }
        .modal-header h3 { font-family: 'Playfair Display', serif; color: var(--navy); display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-600); }

        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; position: relative; top: 0; height: auto; }
            .expiry-grid { grid-template-columns: 1fr; }
            .url-media-grid { grid-template-columns: 1fr; }
            .url-media-input-group { flex-direction: column; }
            .btn-add-media { width: 100%; }
            .link-container { flex-direction: column; }
            .copy-btn { width: 100%; }
            .theme-grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 480px) {
            .main-content { padding: 1.5rem; }
            .form-card { padding: 1.5rem; }
            .theme-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Memproses...</div>
        </div>
    </div>

    <header class="header">
        <div class="logo">
            <div class="logo-image"></div>
            <div class="logo-text">FIOR<span>CARD</span></div>
        </div>
        <div class="datetime">
            <i class="fas fa-calendar-alt"></i>
            <span id="currentDateTime">Memuat...</span>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"></div>
                <div class="sidebar-title">FIOR CARD</div>
            </div>
            <nav>
                <div class="nav-item active" data-page="create-card"><i class="fas fa-magic"></i><span>Buat Card</span></div>
                <div class="nav-item" data-page="customers"><i class="fas fa-users"></i><span>Customers</span></div>
                <div class="nav-item" data-page="history"><i class="fas fa-history"></i><span>History</span></div>
                <div class="nav-item" data-page="settings"><i class="fas fa-cog"></i><span>Settings</span></div>
            </nav>
            <div class="status" id="connectionStatus">
                <span class="status-dot" id="statusDot"></span>
                <span class="status-text" id="statusText">Mengecek koneksi...</span>
            </div>
        </aside>

        <main class="main-content">
            <div id="alertSuccess" class="alert alert-success"></div>
            <div id="alertError" class="alert alert-error"></div>
            <div id="alertInfo" class="alert alert-info"></div>

            <div id="create-card" class="page active">
                <h1 class="page-title"><i class="fas fa-magic"></i> Buat Card Baru</h1>
                <div class="page-subtitle">Generate kartu ucapan digital dengan short link dan pilih masa berlaku</div>

                <div class="form-card">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-user"></i> Nama Penerima <span style="color: var(--danger);">*</span></label>
                        <input type="text" class="form-control" id="recipientName" placeholder="Masukkan nama penerima">
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fab fa-whatsapp"></i> Nomor WhatsApp <span style="color: var(--danger);">*</span></label>
                        <input type="tel" class="form-control" id="whatsappNumber" placeholder="081234567890">
                        <small style="color: var(--gray-600); display: block; margin-top: 0.25rem;"><i class="fas fa-info-circle"></i> Format: 08xx atau 628xx</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-comment"></i> Pesan Ucapan <span style="color: var(--danger);">*</span></label>
                        <textarea class="form-control" id="cardMessage" placeholder="Tulis pesan ucapan Anda... (minimal 20 karakter)" rows="5"></textarea>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
                            <small style="color: var(--gray-600);">Minimal 20 karakter</small>
                            <small style="color: var(--gray-600);"><span id="charCount">0</span>/1000</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-clock"></i> Masa Berlaku Card <span style="color: var(--danger);">*</span></label>
                        <div class="expiry-grid">
                            <div class="expiry-card" id="expiry30" onclick="selectExpiry('30')">
                                <div class="expiry-icon"><i class="fas fa-calendar-alt"></i></div>
                                <div class="expiry-value">30</div>
                                <div class="expiry-label">Hari</div>
                                <span class="expiry-badge">Standar</span>
                            </div>
                            <div class="expiry-card selected" id="expiry90" onclick="selectExpiry('90')">
                                <div class="expiry-icon"><i class="fas fa-calendar-check"></i></div>
                                <div class="expiry-value">90</div>
                                <div class="expiry-label">Hari</div>
                                <span class="expiry-badge">Rekomendasi</span>
                            </div>
                            <div class="expiry-card" id="expiryNever" onclick="selectExpiry('never')">
                                <div class="expiry-icon"><i class="fas fa-infinity"></i></div>
                                <div class="expiry-value">âˆž</div>
                                <div class="expiry-label">Permanen</div>
                                <span class="expiry-badge permanent">Selamanya</span>
                            </div>
                        </div>
                        <input type="hidden" id="selectedExpiry" value="90">
                    </div>

                    <div class="url-media-section">
                        <div class="url-media-header">
                            <i class="fas fa-photo-video"></i>
                            <span>Multiple URL Media (Maksimal 10)</span>
                            <span class="url-media-badge" id="mediaCountBadge">0/10</span>
                        </div>
                        
                        <div class="url-media-grid">
                            <div class="url-media-input-group">
                                <input type="url" class="url-media-input" id="mediaUrlInput" placeholder="https://example.com/gambar.jpg atau video.mp4">
                                <select class="url-media-type" id="mediaTypeSelect">
                                    <option value="auto">Auto Detect</option>
                                    <option value="image">Gambar</option>
                                    <option value="video">Video</option>
                                </select>
                            </div>
                            <button type="button" class="btn-add-media" id="addMediaBtn" onclick="addMediaUrl()"><i class="fas fa-plus-circle"></i> Tambah Media</button>
                        </div>
                        
                        <div id="mediaListContainer" class="media-list"></div>
                        <input type="hidden" id="mediaUrls" value="[]">
                        
                        <small style="color: var(--gray-600); display: block; margin-top: 1rem;">
                            <i class="fas fa-info-circle"></i> Maksimal <strong>10 media</strong> (gambar/video). Akan tampil sebagai carousel di card.
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-palette"></i> Pilih Tema (11 Tema Premium)</label>
                        <div class="theme-grid" id="themeGrid"></div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-primary" style="flex: 2;" onclick="createCard()"><i class="fas fa-magic"></i> GENERATE CARD</button>
                        <button class="btn btn-primary" style="flex: 1; background: var(--success);" onclick="previewCard()"><i class="fas fa-eye"></i> Preview</button>
                        <button class="btn btn-primary" style="flex: 1; background: var(--gray-600);" onclick="resetForm()"><i class="fas fa-undo"></i> Reset</button>
                    </div>
                </div>

                <div id="cardResult" class="result-card">
                    <h3 style="color: var(--success); margin-bottom: 1.5rem;"><i class="fas fa-check-circle"></i> CARD BERHASIL DIBUAT!</h3>
                    
                    <div style="background: var(--soft-white); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-user" style="color: var(--gold);"></i>
                            <span id="resultRecipient" style="font-weight: 600;"></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-palette" style="color: var(--gold);"></i>
                            <span id="resultTheme"></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-photo-video" style="color: var(--gold);"></i>
                            <span id="resultMediaCount"></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                            <i class="fas fa-clock" style="color: var(--info);"></i>
                            <span id="resultExpiry">Masa berlaku: 90 hari</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-link"></i> SHORT LINK CARD</label>
                        <div class="link-container">
                            <span class="short-link" id="generatedLink">https://fiorcard.com/xxx</span>
                            <button class="copy-btn" onclick="copyLink()"><i class="fas fa-copy"></i> Copy</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-qrcode"></i> QR CODE</label>
                        <div class="qrcode-container" id="qrcode"></div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <a href="#" target="_blank" class="btn btn-success" id="whatsappResultBtn" style="flex: 1;"><i class="fab fa-whatsapp"></i> Kirim WA</a>
                        <a href="#" target="_blank" class="btn btn-primary" id="previewResultBtn" style="flex: 1;"><i class="fas fa-eye"></i> Buka Card</a>
                    </div>
                </div>
            </div>

            <div id="customers" class="page">
                <h1 class="page-title"><i class="fas fa-users"></i> Data Customers</h1>
                <div class="page-subtitle">Kelola database customer FIOR Florist</div>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <button class="btn btn-primary" onclick="showAddCustomerModal()"><i class="fas fa-user-plus"></i> Tambah Customer</button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr><th>Nama</th><th>No. WhatsApp</th><th>Email</th><th>Alamat</th><th>Catatan</th><th>Aksi</th></tr>
                        </thead>
                        <tbody id="customersTableBody"><tr><td colspan="6" style="text-align: center; padding: 2rem;">Memuat data...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="history" class="page">
                <h1 class="page-title"><i class="fas fa-history"></i> History Cards</h1>
                <div class="page-subtitle">Riwayat semua card yang telah dibuat</div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr><th>Tanggal</th><th>Penerima</th><th>Tema</th><th>Jumlah Media</th><th>Link</th><th>Masa Berlaku</th></tr>
                        </thead>
                        <tbody id="historyTableBody"><tr><td colspan="6" style="text-align: center; padding: 2rem;">Memuat data...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="settings" class="page">
                <h1 class="page-title"><i class="fas fa-cog"></i> Settings</h1>
                <div class="page-subtitle">Konfigurasi API dan sistem</div>

                <div class="form-card">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-link"></i> Google Apps Script URL</label>
                        <input type="url" class="form-control" id="scriptUrl" 
                               placeholder="https://script.google.com/macros/s/.../exec"
                               value="https://script.google.com/macros/s/AKfycbzTPgv-D6VNNlh0QHERaizfzN4tWCs42Xdr3sZLdpIzs3oHQAuz5D-6tqfO5U7E2QHmEw/exec">
                        <small style="color: var(--gray-600); display: block; margin-top: 0.25rem;">
                            <i class="fas fa-info-circle"></i> URL setelah deploy web app
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-globe"></i> Card Base URL</label>
                        <input type="url" class="form-control" id="cardBaseUrl" 
                               value="https://fiorfloristjayapura-commits.github.io/cardgift-fior/card.html">
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-icon"><i class="fas fa-envelope"></i></div><div class="stat-value" id="totalMessages">0</div><div class="stat-label">Total Pesan</div></div>
                        <div class="stat-card"><div class="stat-icon"><i class="fas fa-check-circle"></i></div><div class="stat-value" id="activeMessages">0</div><div class="stat-label">Pesan Aktif</div></div>
                        <div class="stat-card"><div class="stat-icon"><i class="fas fa-hourglass-end"></i></div><div class="stat-value" id="expiredMessages">0</div><div class="stat-label">Kadaluarsa</div></div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save"></i> Simpan Settings</button>
                        <button class="btn btn-info" onclick="testConnection()"><i class="fas fa-wifi"></i> Test Connection</button>
                        <button class="btn btn-purple" onclick="runCleanup()"><i class="fas fa-broom"></i> Cleanup Expired</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Tambah Customer</h3>
                <button class="modal-close" onclick="closeCustomerModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Nama Lengkap *</label><input type="text" class="form-control" id="modalCustomerName" placeholder="Masukkan nama lengkap"></div>
                <div class="form-group"><label class="form-label">No. WhatsApp *</label><input type="tel" class="form-control" id="modalCustomerPhone" placeholder="081234567890"></div>
                <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-control" id="modalCustomerEmail" placeholder="customer@example.com"></div>
                <div class="form-group"><label class="form-label">Alamat</label><textarea class="form-control" id="modalCustomerAddress" rows="2" placeholder="Jl. Contoh No. 123, Kota, Provinsi"></textarea></div>
                <div class="form-group"><label class="form-label">Catatan</label><textarea class="form-control" id="modalCustomerNotes" rows="3" placeholder="Catatan khusus tentang customer..."></textarea></div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="saveCustomer()"><i class="fas fa-save"></i> Simpan</button>
                <button class="btn btn-primary" style="background: var(--gray-600);" onclick="closeCustomerModal()">Batal</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIOR CARD ADMIN - LINK PENDEK (HANYA v=ID)
        // ============================================

        const CONFIG = {
            SCRIPT_URL: "https://script.google.com/macros/s/AKfycbzTPgv-D6VNNlh0QHERaizfzN4tWCs42Xdr3sZLdpIzs3oHQAuz5D-6tqfO5U7E2QHmEw/exec",
            CARD_BASE_URL: "https://fiorfloristjayapura-commits.github.io/cardgift-fior/card.html",
            DEFAULT_THEME: "birthday",
            DEFAULT_EXPIRY: "90"
        };

        // Themes
        const THEMES = [
            { id: 'birthday', name: 'Birthday', emoji: 'ðŸŽ‚' },
            { id: 'valentine', name: 'Valentine', emoji: 'â¤ï¸' },
            { id: 'wedding', name: 'Wedding', emoji: 'ðŸ’' },
            { id: 'anniversary', name: 'Anniversary', emoji: 'ðŸŽ‰' },
            { id: 'graduation', name: 'Graduation', emoji: 'ðŸŽ“' },
            { id: 'condolence', name: 'Condolence', emoji: 'ðŸ•Šï¸' },
            { id: 'congratulation', name: 'Congratulations', emoji: 'ðŸŽŠ' },
            { id: 'imlek', name: 'Imlek', emoji: 'ðŸ§§' },
            { id: 'lebaran', name: 'Lebaran', emoji: 'ðŸŒ™' },
            { id: 'natal', name: 'Natal', emoji: 'ðŸŽ„' },
            { id: 'newyear', name: 'New Year', emoji: 'ðŸŽ†' }
        ];

        // State
        let state = {
            customers: [],
            cards: [],
            selectedTheme: CONFIG.DEFAULT_THEME,
            mediaUrls: [],
            selectedExpiry: CONFIG.DEFAULT_EXPIRY
        };

        // DOM Elements
        const el = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            cacheElements();
            loadSettings();
            loadThemes();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            setupNavigation();
            loadCustomers();
            loadCards();
            loadStats();
            setTimeout(() => testConnection(true), 1000);
        });

        function cacheElements() {
            const ids = [
                'loadingOverlay', 'loadingText',
                'alertSuccess', 'alertError', 'alertInfo',
                'currentDateTime', 'connectionStatus', 'statusText', 'statusDot',
                'recipientName', 'whatsappNumber', 'cardMessage', 'charCount',
                'mediaUrlInput', 'mediaTypeSelect', 'mediaListContainer', 'mediaUrls', 'mediaCountBadge', 'addMediaBtn',
                'themeGrid', 'cardResult', 'generatedLink',
                'whatsappResultBtn', 'previewResultBtn', 'qrcode',
                'resultRecipient', 'resultTheme', 'resultMediaCount', 'resultExpiry',
                'customersTableBody', 'historyTableBody',
                'scriptUrl', 'cardBaseUrl',
                'modalCustomerName', 'modalCustomerPhone', 
                'modalCustomerEmail', 'modalCustomerAddress', 'modalCustomerNotes',
                'totalMessages', 'activeMessages', 'expiredMessages',
                'expiry30', 'expiry90', 'expiryNever', 'selectedExpiry'
            ];
            ids.forEach(id => el[id] = document.getElementById(id));
        }

        function updateDateTime() {
            if (el.currentDateTime) {
                const now = new Date();
                el.currentDateTime.innerHTML = now.toLocaleDateString('id-ID', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            }
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById(this.dataset.page).classList.add('active');
                    
                    if (this.dataset.page === 'customers') loadCustomers();
                    if (this.dataset.page === 'history') loadCards();
                    if (this.dataset.page === 'settings') loadStats();
                });
            });
        }

        function loadThemes() {
            if (!el.themeGrid) return;
            el.themeGrid.innerHTML = '';
            THEMES.forEach(theme => {
                const div = document.createElement('div');
                div.className = `theme-card ${theme.id === state.selectedTheme ? 'active' : ''}`;
                div.dataset.theme = theme.id;
                div.innerHTML = `<div class="theme-emoji">${theme.emoji}</div><div class="theme-name">${theme.name}</div>`;
                div.onclick = () => {
                    state.selectedTheme = theme.id;
                    document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
                    div.classList.add('active');
                };
                el.themeGrid.appendChild(div);
            });
        }

        window.selectExpiry = function(value) {
            document.querySelectorAll('.expiry-card').forEach(card => card.classList.remove('selected'));
            if (value === '30') document.getElementById('expiry30').classList.add('selected');
            else if (value === '90') document.getElementById('expiry90').classList.add('selected');
            else if (value === 'never') document.getElementById('expiryNever').classList.add('selected');
            state.selectedExpiry = value;
            if (el.selectedExpiry) el.selectedExpiry.value = value;
        };

        function generateShortId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let id = '';
            for (let i = 0; i < 8; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
            return id;
        }

        window.addMediaUrl = function() {
            const url = el.mediaUrlInput?.value.trim();
            const type = el.mediaTypeSelect?.value || 'auto';
            
            if (state.mediaUrls.length >= 10) {
                showAlert('Maksimal 10 media! Hapus beberapa untuk menambah.', 'error');
                return;
            }
            if (!url) { showAlert('Masukkan URL terlebih dahulu!', 'error'); return; }
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showAlert('URL harus dimulai dengan http:// atau https://', 'error');
                return;
            }
            
            let detectedType = type;
            if (type === 'auto') {
                const extension = url.split('.').pop().toLowerCase();
                if (['mp4', 'mov', 'webm', 'avi', 'mkv'].includes(extension) || 
                    url.includes('youtube.com') || url.includes('vimeo.com') || url.includes('drive.google.com')) {
                    detectedType = 'video';
                } else {
                    detectedType = 'image';
                }
            }
            
            state.mediaUrls.push({ url, type: detectedType, id: Date.now() + Math.random() });
            if (el.mediaUrls) el.mediaUrls.value = JSON.stringify(state.mediaUrls);
            renderMediaList();
            el.mediaUrlInput.value = '';
            el.mediaTypeSelect.value = 'auto';
            updateMediaCount();
            showAlert('URL media ditambahkan!', 'success');
        };

        window.removeMediaUrl = function(id) {
            state.mediaUrls = state.mediaUrls.filter(item => item.id !== id);
            if (el.mediaUrls) el.mediaUrls.value = JSON.stringify(state.mediaUrls);
            renderMediaList();
            updateMediaCount();
            showAlert('Media dihapus', 'info');
        };

        window.previewMedia = function(url) { window.open(url, '_blank'); };

        function renderMediaList() {
            if (!el.mediaListContainer) return;
            if (state.mediaUrls.length === 0) {
                el.mediaListContainer.innerHTML = '<div style="text-align: center; padding: 2rem; background: var(--soft-white); border-radius: var(--radius-lg);">Belum ada media</div>';
                return;
            }
            let html = '';
            state.mediaUrls.forEach((media, index) => {
                const isVideo = media.type === 'video';
                html += `
                    <div class="media-item">
                        <div class="media-icon"><i class="fas fa-${isVideo ? 'video' : 'image'}"></i></div>
                        <div class="media-details">
                            <div class="media-url">${media.url}</div>
                            <span class="media-type-badge ${isVideo ? 'video' : ''}">${isVideo ? 'VIDEO' : 'GAMBAR'} #${index + 1}</span>
                        </div>
                        <div class="media-actions">
                            <button class="btn-media-preview" onclick="previewMedia('${escapeHTML(media.url)}')"><i class="fas fa-eye"></i></button>
                            <button class="btn-media-remove" onclick="removeMediaUrl(${media.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
            el.mediaListContainer.innerHTML = html;
        }

        function updateMediaCount() {
            if (el.mediaCountBadge) el.mediaCountBadge.textContent = `${state.mediaUrls.length}/10`;
            if (el.resultMediaCount) {
                el.resultMediaCount.textContent = `${state.mediaUrls.length} Media (${state.mediaUrls.filter(m => m.type === 'image').length} Gambar, ${state.mediaUrls.filter(m => m.type === 'video').length} Video)`;
            }
            if (el.addMediaBtn) {
                el.addMediaBtn.disabled = state.mediaUrls.length >= 10;
                el.addMediaBtn.style.opacity = state.mediaUrls.length >= 10 ? '0.5' : '1';
            }
        }

        // ========== CREATE CARD - LINK PENDEK (HANYA v=ID) ==========
        window.createCard = async function() {
            const name = el.recipientName?.value.trim();
            const phone = el.whatsappNumber?.value.trim().replace(/\D/g, '');
            const message = el.cardMessage?.value.trim();
            const theme = state.selectedTheme;
            const expirySetting = state.selectedExpiry;
            
            if (!name) { showAlert('Nama penerima harus diisi!', 'error'); return; }
            if (!phone || phone.length < 10) { showAlert('Nomor WhatsApp tidak valid!', 'error'); return; }
            if (!message || message.length < 20) { showAlert('Pesan minimal 20 karakter!', 'error'); return; }
            
            showLoading(true, 'Menyimpan data...');
            
            try {
                const messageId = generateShortId();
                const mediaUrlsString = state.mediaUrls.map(m => m.url).join('||');
                
                // Kirim semua data ke server (termasuk media)
                const url = `${CONFIG.SCRIPT_URL}?cmd=save&id=${messageId}&msg=${encodeURIComponent(message)}&nama=${encodeURIComponent(name)}&phone=${phone}&theme=${theme}&expiry=${expirySetting}&media=${encodeURIComponent(mediaUrlsString)}`;
                
                console.log('ðŸ“¤ Mengirim ke:', url);
                
                const response = await fetch(url);
                const result = await response.json();
                
                console.log('ðŸ“¥ Response:', result);
                
                if (result.status === 'success') {
                    // LINK PENDEK - HANYA PAKAI PARAMETER v
                    const cardUrl = `${CONFIG.CARD_BASE_URL}?to=${encodeURIComponent(name)}&theme=${theme}&v=${messageId}`;
                    
                    // Tampilkan hasil
                    if (el.generatedLink) el.generatedLink.textContent = cardUrl;
                    if (el.resultRecipient) el.resultRecipient.textContent = name;
                    if (el.resultTheme) {
                        const themeObj = THEMES.find(t => t.id === theme);
                        el.resultTheme.textContent = `${themeObj?.emoji || 'ðŸŽ¨'} ${themeObj?.name || theme}`;
                    }
                    updateMediaCount();
                    
                    let expiryText = '';
                    if (expirySetting === '30') expiryText = '30 hari';
                    else if (expirySetting === '90') expiryText = '90 hari';
                    else expiryText = 'Permanen';
                    if (el.resultExpiry) el.resultExpiry.innerHTML = `<i class="fas fa-clock"></i> Masa berlaku: ${expiryText}`;
                    
                    // QR Code
                    if (el.qrcode) {
                        el.qrcode.innerHTML = '';
                        new QRCode(el.qrcode, {
                            text: cardUrl,
                            width: 200,
                            height: 200,
                            colorDark: "#1e3a5f",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }
                    
                    // WhatsApp button
                    const waNum = phone.startsWith('0') ? '62' + phone.substring(1) : phone;
                    const waMsg = `Halo ${name}, ini kartu ucapan digital dari FIOR Florist:\n\n${cardUrl}`;
                    if (el.whatsappResultBtn) el.whatsappResultBtn.href = `https://wa.me/${waNum}?text=${encodeURIComponent(waMsg)}`;
                    if (el.previewResultBtn) el.previewResultBtn.href = cardUrl;
                    
                    if (el.cardResult) {
                        el.cardResult.classList.add('active');
                        el.cardResult.style.display = 'block';
                        setTimeout(() => el.cardResult.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200);
                    }
                    
                    showAlert('âœ… CARD BERHASIL DIBUAT!', 'success');
                    
                } else {
                    throw new Error(result.message || 'Gagal');
                }
                
            } catch (error) {
                console.error('âŒ Error:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };

        window.previewCard = function() {
            const name = el.recipientName?.value.trim() || 'Preview';
            const theme = state.selectedTheme;
            const messageId = 'preview_' + generateShortId();
            
            // Untuk preview, kita tetap kirim media via URL (karena belum disimpan)
            let url = `${CONFIG.CARD_BASE_URL}?to=${encodeURIComponent(name)}&theme=${theme}&v=${messageId}&preview=true`;
            
            if (state.mediaUrls.length > 0) {
                state.mediaUrls.forEach((media, index) => {
                    const paramName = index === 0 ? 'media' : `media${index + 1}`;
                    url += `&${paramName}=${encodeURIComponent(media.url)}`;
                });
            }
            window.open(url, '_blank');
        };

        window.resetForm = function() {
            if (el.recipientName) el.recipientName.value = '';
            if (el.whatsappNumber) el.whatsappNumber.value = '';
            if (el.cardMessage) el.cardMessage.value = '';
            if (el.charCount) el.charCount.textContent = '0';
            state.mediaUrls = [];
            if (el.mediaUrls) el.mediaUrls.value = '[]';
            renderMediaList();
            updateMediaCount();
            state.selectedTheme = CONFIG.DEFAULT_THEME;
            document.querySelectorAll('.theme-card').forEach(c => {
                c.classList.toggle('active', c.dataset.theme === CONFIG.DEFAULT_THEME);
            });
            selectExpiry(CONFIG.DEFAULT_EXPIRY);
            showAlert('Form direset', 'info');
        };

        window.copyLink = function() {
            const link = el.generatedLink?.textContent;
            if (!link || link === 'https://fiorcard.com/xxx') {
                showAlert('Tidak ada link untuk dicopy', 'error');
                return;
            }
            navigator.clipboard.writeText(link)
                .then(() => showAlert('âœ… Link berhasil dicopy!', 'success'))
                .catch(() => showAlert('âŒ Gagal copy link', 'error'));
        };

        window.testConnection = async function(silent = false) {
            if (!silent) showLoading(true, 'Testing koneksi...');
            try {
                const url = `${CONFIG.SCRIPT_URL}?cmd=test&t=${Date.now()}`;
                console.log('ðŸ“¤ Testing connection:', url);
                
                const response = await fetch(url);
                const result = await response.json();
                console.log('ðŸ“¥ Response:', result);
                
                if (result.status === 'success') {
                    if (!silent) showAlert('âœ… Koneksi berhasil!', 'success');
                    if (el.statusText) {
                        el.statusText.textContent = 'Terhubung';
                        el.statusText.classList.remove('offline');
                    }
                    if (el.statusDot) el.statusDot.classList.remove('offline');
                    return true;
                } else {
                    throw new Error('Invalid response');
                }
            } catch (error) {
                console.error('âŒ Connection error:', error);
                if (!silent) showAlert('âŒ Koneksi gagal! Periksa URL Script', 'error');
                if (el.statusText) {
                    el.statusText.textContent = 'Gagal konek';
                    el.statusText.classList.add('offline');
                }
                if (el.statusDot) el.statusDot.classList.add('offline');
                return false;
            } finally {
                if (!silent) showLoading(false);
            }
        };

        async function loadCustomers() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?type=customers&t=${Date.now()}`);
                const data = await response.json();
                state.customers = Array.isArray(data) ? data : [];
                renderCustomersTable();
            } catch (error) {
                console.error('Load customers error:', error);
                if (el.customersTableBody) {
                    el.customersTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--danger);">Gagal memuat data</td></tr>';
                }
            }
        }

        function renderCustomersTable() {
            if (!el.customersTableBody) return;
            if (state.customers.length === 0) {
                el.customersTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">Belum ada data customer</td></tr>';
                return;
            }
            let html = '';
            state.customers.slice(0, 20).forEach(c => {
                html += `
                    <tr>
                        <td><strong>${c.nama || ''}</strong></td>
                        <td>${c.no_hp || ''}</td>
                        <td>${c.email || '-'}</td>
                        <td>${c.alamat || '-'}</td>
                        <td>${c.catatan || '-'}</td>
                        <td><button class="btn btn-primary btn-sm" onclick="useCustomer('${escapeHTML(c.nama)}', '${escapeHTML(c.no_hp)}')"><i class="fas fa-gift"></i> Pilih</button></td>
                    </tr>
                `;
            });
            el.customersTableBody.innerHTML = html;
        }

        window.useCustomer = function(name, phone) {
            if (el.recipientName) el.recipientName.value = name || '';
            if (el.whatsappNumber) el.whatsappNumber.value = phone || '';
            showAlert(`Customer "${name}" dipilih`, 'success');
            document.querySelector('.nav-item[data-page="create-card"]').click();
        };

        async function loadCards() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?type=cards&t=${Date.now()}`);
                const data = await response.json();
                state.cards = Array.isArray(data) ? data : [];
                renderCardsTable();
            } catch (error) {
                console.error('Load cards error:', error);
                if (el.historyTableBody) {
                    el.historyTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--danger);">Gagal memuat data</td></tr>';
                }
            }
        }

        function renderCardsTable() {
            if (!el.historyTableBody) return;
            if (state.cards.length === 0) {
                el.historyTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">Belum ada card</td></tr>';
                return;
            }
            let html = '';
            state.cards.slice(0, 20).forEach(c => {
                const mediaCount = c.total_media || '0';
                let expiryText = '', statusClass = '';
                if (c.expiry_setting === 'never') {
                    expiryText = 'Permanen';
                    statusClass = 'permanent';
                } else if (c.expiry_setting === '30') {
                    expiryText = '30 hari';
                    statusClass = 'active';
                } else if (c.expiry_setting === '90') {
                    expiryText = '90 hari';
                    statusClass = 'active';
                } else {
                    expiryText = c.expiry_setting || '-';
                }
                html += `
                    <tr>
                        <td>${c.timestamp ? new Date(c.timestamp).toLocaleDateString('id-ID') : '-'}</td>
                        <td>${c.nama_penerima || c.name || '-'}</td>
                        <td>${c.tema || c.theme || '-'}</td>
                        <td style="text-align: center;">${mediaCount} Media</td>
                        <td><a href="${c.link || '#'}" target="_blank" class="btn btn-primary btn-sm">Lihat</a></td>
                        <td><span class="expiry-status ${statusClass}">${expiryText}</span></td>
                    </tr>
                `;
            });
            el.historyTableBody.innerHTML = html;
        }

        async function loadStats() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?type=get_stats&t=${Date.now()}`);
                const data = await response.json();
                if (data.status === 'success') {
                    if (el.totalMessages) el.totalMessages.textContent = data.total_messages || 0;
                    if (el.activeMessages) el.activeMessages.textContent = data.active_messages || 0;
                    if (el.expiredMessages) el.expiredMessages.textContent = data.expired_messages || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        window.showAddCustomerModal = function() { document.getElementById('customerModal').classList.add('active'); };
        window.closeCustomerModal = function() {
            document.getElementById('customerModal').classList.remove('active');
            ['modalCustomerName','modalCustomerPhone','modalCustomerEmail','modalCustomerAddress','modalCustomerNotes'].forEach(id => {
                const elm = document.getElementById(id);
                if (elm) elm.value = '';
            });
        };

        window.saveCustomer = async function() {
            const name = el.modalCustomerName?.value.trim();
            const phone = el.modalCustomerPhone?.value.trim();
            const email = el.modalCustomerEmail?.value.trim();
            const address = el.modalCustomerAddress?.value.trim();
            const notes = el.modalCustomerNotes?.value.trim();
            
            if (!name || !phone) { showAlert('Nama dan No. WA wajib diisi!', 'error'); return; }
            showLoading(true, 'Menyimpan customer...');
            
            try {
                const formData = new URLSearchParams();
                formData.append('type', 'customer');
                formData.append('nama', name);
                formData.append('no_hp', phone);
                formData.append('email', email || '');
                formData.append('alamat', address || '');
                formData.append('catatan', notes || '');
                
                const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formData.toString() });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('âœ… Customer berhasil disimpan!', 'success');
                    closeCustomerModal();
                    await loadCustomers();
                } else {
                    throw new Error(result.message || 'Gagal menyimpan');
                }
            } catch (error) {
                console.error('Save customer error:', error);
                showAlert('âŒ Gagal: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };

        function loadSettings() {
            const saved = localStorage.getItem('fior_settings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    if (settings.scriptUrl && el.scriptUrl) {
                        el.scriptUrl.value = settings.scriptUrl;
                        CONFIG.SCRIPT_URL = settings.scriptUrl;
                    }
                    if (settings.cardBaseUrl && el.cardBaseUrl) {
                        el.cardBaseUrl.value = settings.cardBaseUrl;
                        CONFIG.CARD_BASE_URL = settings.cardBaseUrl;
                    }
                } catch (e) {}
            }
        }

        window.saveSettings = function() {
            const settings = {
                scriptUrl: el.scriptUrl?.value || CONFIG.SCRIPT_URL,
                cardBaseUrl: el.cardBaseUrl?.value || CONFIG.CARD_BASE_URL
            };
            localStorage.setItem('fior_settings', JSON.stringify(settings));
            CONFIG.SCRIPT_URL = settings.scriptUrl;
            CONFIG.CARD_BASE_URL = settings.cardBaseUrl;
            showAlert('âœ… Settings tersimpan!', 'success');
        };

        window.runCleanup = async function() {
            if (!confirm('Yakin ingin membersihkan semua pesan yang sudah kadaluarsa?')) return;
            showLoading(true, 'Membersihkan pesan expired...');
            try {
                const formData = new URLSearchParams();
                formData.append('type', 'cleanup');
                const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formData.toString() });
                const result = await response.json();
                if (result.status === 'success') {
                    showAlert(`âœ… Berhasil membersihkan ${result.cleaned} pesan expired!`, 'success');
                    await loadStats();
                    await loadCards();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showAlert('âŒ Gagal: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };

        function showAlert(message, type = 'success') {
            let alertEl;
            if (type === 'success') alertEl = el.alertSuccess;
            else if (type === 'error') alertEl = el.alertError;
            else alertEl = el.alertInfo;
            if (alertEl) {
                alertEl.textContent = message;
                alertEl.style.display = 'block';
                setTimeout(() => alertEl.style.display = 'none', 3000);
            }
        }

        function showLoading(show, text = 'Loading...') {
            if (el.loadingOverlay) {
                if (show) {
                    el.loadingOverlay.style.display = 'flex';
                    if (el.loadingText) el.loadingText.textContent = text;
                } else {
                    el.loadingOverlay.style.display = 'none';
                }
            }
        }

        function escapeHTML(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"]/g, function(m) {
                return { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[m];
            });
        }

        if (el.cardMessage) {
            el.cardMessage.addEventListener('input', function() {
                if (el.charCount) el.charCount.textContent = this.value.length;
            });
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };
    </script>
</body>
</html>
