<script>
/* ================= CONFIG FINAL ================= */
const CONFIG = {
    SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxIquhuDtAzIUHhpaVoYgLVtCvKEHNDVqwqrfZtfx3NrQ2CZrwivK3jAv9ioOU88ajPrw/exec",
    CARD_BASE_URL: "https://fiorfloristjayapura-commits.github.io/cardgift-fior/card.html",
    COMPANY_NAME: "FIOR Florist",
    DEFAULT_THEME: "birthday",
    MAX_FILE_SIZE: 10 * 1024 * 1024,
    MAX_VIDEO_DURATION: 30
};

/* ================= STATE ================= */
let state = {
    uploadedMedia: null,
    settings: {}
};

/* ================= SETTINGS ================= */
function loadSettings() {
    const saved = localStorage.getItem('fior_settings');

    if (saved) {
        state.settings = JSON.parse(saved);

        if (state.settings.scriptUrl && state.settings.scriptUrl.trim() !== "") {
            CONFIG.SCRIPT_URL = state.settings.scriptUrl;
        }

        if (state.settings.cardUrl && state.settings.cardUrl.trim() !== "") {
            CONFIG.CARD_BASE_URL = state.settings.cardUrl;
        }
    }

    const scriptInput = document.getElementById('scriptUrl');
    const cardInput = document.getElementById('cardUrl');

    if (scriptInput) scriptInput.value = CONFIG.SCRIPT_URL;
    if (cardInput) cardInput.value = CONFIG.CARD_BASE_URL;
}

function saveSettings() {
    const scriptUrlValue = document.getElementById('scriptUrl').value.trim();
    const cardUrlValue = document.getElementById('cardUrl').value.trim();

    if (!scriptUrlValue) {
        alert('Google Apps Script URL tidak boleh kosong');
        return;
    }

    state.settings = {
        scriptUrl: scriptUrlValue,
        cardUrl: cardUrlValue
    };

    localStorage.setItem('fior_settings', JSON.stringify(state.settings));

    CONFIG.SCRIPT_URL = scriptUrlValue;
    CONFIG.CARD_BASE_URL = cardUrlValue;

    alert('Settings saved!');
}

/* ================= FILE TO BASE64 ================= */
async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

/* ================= UPLOAD FUNCTION (FIXED) ================= */
async function uploadToGoogleDrive(file) {
    if (!CONFIG.SCRIPT_URL || CONFIG.SCRIPT_URL.trim() === "") {
        throw new Error("Google Apps Script URL belum diset.");
    }

    const base64Data = await fileToBase64(file);
    const base64Content = base64Data.split(',')[1];

    const uploadData = {
        type: "media",
        filename: file.name,
        data: base64Content,
        mimeType: file.type,
        cardId: "upload_" + Date.now()
    };

    const response = await fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(uploadData)
    });

    const result = await response.json();

    if (result.status !== "success") {
        throw new Error(result.message || "Upload gagal");
    }

    let mediaUrl = result.url;

    if (!mediaUrl && result.fileId) {
        mediaUrl = `https://drive.google.com/uc?id=${result.fileId}&export=download`;
    }

    return mediaUrl;
}

/* ================= CREATE CARD ================= */
async function createCard() {
    const name = document.getElementById('recipientName').value;
    const phone = document.getElementById('whatsappNumber').value;
    const message = document.getElementById('cardMessage').value;
    const theme = document.getElementById('selectedTheme').value;

    let mediaUrl = "";

    if (state.uploadedMedia) {
        mediaUrl = await uploadToGoogleDrive(state.uploadedMedia.file);
    }

    let cardUrl = `${CONFIG.CARD_BASE_URL}?to=${encodeURIComponent(name)}&msg=${encodeURIComponent(message)}&theme=${theme}`;

    if (mediaUrl) {
        cardUrl += `&media=${encodeURIComponent(mediaUrl)}`;
    }

    alert("Card created:\n" + cardUrl);
}

/* ================= FILE SELECT ================= */
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    state.uploadedMedia = { file: file };
}

/* ================= INIT ================= */
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
});
</script>
