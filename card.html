// ====================================================
// FIOR CARD - COMPLETE WITH PER-CARD EXPIRY (FIXED)
// ====================================================

const SPREADSHEET_ID = '1KZqOZ5IJzxUj93r-8AByM_vwHUFyGzleT5DDL60zm0g';

// ========== DO POST ==========
function doPost(e) {
  try {
    let data = e?.parameter || {};
    
    if (data.type === 'test') {
      return jsonResponse({ status: 'success', message: '‚úÖ CONNECTED!' });
    }
    
    if (data.type === 'customer') {
      return saveCustomer(data);
    }
    
    if (data.type === 'card') {
      return saveCard(data);
    }
    
    if (data.type === 'save_message') {
      return saveMessage(data);
    }
    
    if (data.type === 'get_message') {
      return getMessage(data);
    }
    
    if (data.type === 'get_stats') {
      return getStats();
    }
    
    if (data.type === 'cleanup') {
      const count = cleanupExpiredMessages();
      return jsonResponse({ status: 'success', cleaned: count });
    }
    
    return jsonResponse({ status: 'error', message: 'Unknown type' });
    
  } catch (error) {
    return jsonResponse({ status: 'error', message: error.message });
  }
}

// ========== DO GET ==========
function doGet(e) {
  const params = e?.parameter || {};
  
  if (params.type === 'test') {
    return jsonResponse({ status: 'success', message: 'GET API OK' });
  }
  
  if (params.type === 'customers') {
    return getCustomers();
  }
  
  if (params.type === 'cards') {
    return getCards();
  }
  
  if (params.type === 'get_message' && params.id) {
    return getMessage({ parameter: { id: params.id } });
  }
  
  if (params.type === 'get_stats') {
    return getStats();
  }
  
  return jsonResponse({ status: 'success', message: 'FIOR Card API' });
}

// ========== SAVE CUSTOMER ==========
function saveCustomer(data) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName('customers');
    
    if (!sheet) {
      sheet = ss.insertSheet('customers');
      sheet.getRange(1,1,1,8).setValues([[
        'Timestamp', 'Nama', 'No_HP', 'Catatan', 'Email', 'Alamat', 'Tgl_Daftar', 'Status'
      ]]).setFontWeight('bold');
    }
    
    sheet.appendRow([
      new Date(),
      data.nama || '',
      data.no_hp || '',
      data.catatan || '',
      data.email || '',
      data.alamat || '',
      Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd'),
      'Active'
    ]);
    
    return jsonResponse({ status: 'success', message: 'Customer saved' });
    
  } catch (error) {
    return jsonResponse({ status: 'error', message: error.message });
  }
}

// ========== SAVE CARD ==========
function saveCard(data) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName('cards');
    
    if (!sheet) {
      sheet = ss.insertSheet('cards');
      sheet.getRange(1,1,1,13).setValues([[
        'Timestamp', 'Nama_Penerima', 'No_HP', 'Tema', 'Pesan', 'Link', 'Media_URL',
        'Status', 'WhatsApp_Sent', 'Views', 'Creator', 'Message_ID', 'Expiry_Setting'
      ]]).setFontWeight('bold');
    }
    
    sheet.appendRow([
      new Date(),
      data.nama || '',
      data.no_hp || '',
      data.tema || 'birthday',
      data.pesan || '',
      data.link || '',
      data.media_url || '',
      'Generated',
      'No',
      0,
      data.creator || 'Admin',
      data.message_id || '',
      data.expiry_setting || '90'
    ]);
    
    return jsonResponse({ status: 'success', message: 'Card saved' });
    
  } catch (error) {
    return jsonResponse({ status: 'error', message: error.message });
  }
}

// ========== SAVE MESSAGE WITH PER-CARD EXPIRY ==========
function saveMessage(data) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName('messages');
    
    if (!sheet) {
      sheet = ss.insertSheet('messages');
      sheet.getRange(1,1,1,9).setValues([[
        'ID', 'Message', 'Nama_Penerima', 'No_HP', 'Timestamp', 'Expires', 'Expiry_Days', 'Status', 'Expiry_Setting'
      ]]).setFontWeight('bold');
    }
    
    const messageId = data.id || generateId();
    const expirySetting = data.expiry_setting || '90'; // '30', '90', or 'never'
    
    // Determine expiry days and date
    let expiryDays;
    let expires;
    const now = new Date();
    
    if (expirySetting === 'never') {
      expiryDays = 9999; // Special value for permanent
      expires = new Date('2099-12-31'); // Set to far future
    } else {
      expiryDays = parseInt(expirySetting) || 90;
      expires = new Date();
      expires.setDate(expires.getDate() + expiryDays);
    }
    
    sheet.appendRow([
      messageId,
      data.message || '',
      data.nama || '',
      data.no_hp || '',
      now,
      expires,
      expiryDays,
      'Active',
      expirySetting
    ]);
    
    return jsonResponse({ 
      status: 'success', 
      message: 'Message saved',
      id: messageId,
      expires: expires.toString(),
      expiry_setting: expirySetting,
      expiry_days: expiryDays
    });
    
  } catch (error) {
    return jsonResponse({ status: 'error', message: error.message });
  }
}

// ========== GET MESSAGE WITH EXPIRY CHECK ==========
function getMessage(data) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('messages');
    
    if (!sheet || sheet.getLastRow() <= 1) {
      return jsonResponse({ status: 'error', message: 'Message not found' });
    }
    
    const rows = sheet.getDataRange().getValues();
    const messageId = data.id;
    
    for (let i = 1; i < rows.length; i++) {
      if (rows[i][0] === messageId) {
        // Get expiry setting
        const expirySetting = rows[i][8] || '90';
        const expires = new Date(rows[i][5]);
        const now = new Date();
        
        // Calculate days remaining
        let daysRemaining = null;
        let isExpired = false;
        
        if (expirySetting === 'never') {
          daysRemaining = null; // Permanent
          isExpired = false;
        } else {
          // Hitung selisih hari
          const diffTime = expires.getTime() - now.getTime();
          daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          // Jika sudah expired
          if (daysRemaining < 0) {
            isExpired = true;
            daysRemaining = 0;
          }
        }
        
        // Log untuk debugging
        console.log({
          messageId: messageId,
          expirySetting: expirySetting,
          expires: expires.toString(),
          now: now.toString(),
          daysRemaining: daysRemaining,
          isExpired: isExpired
        });
        
        return jsonResponse({
          status: 'success',
          message: rows[i][1],
          nama: rows[i][2],
          no_hp: rows[i][3],
          timestamp: rows[i][4].toString(),
          expires: expires.toString(),
          days_remaining: daysRemaining,
          is_expired: isExpired,
          expiry_setting: expirySetting,
          expiry_days: rows[i][6] || 90
        });
      }
    }
    
    return jsonResponse({ status: 'error', message: 'Message not found' });
    
  } catch (error) {
    return jsonResponse({ status: 'error', message: error.message });
  }
}

// ========== GET CUSTOMERS ==========
function getCustomers() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('customers');
    if (!sheet || sheet.getLastRow() <= 1) return jsonResponse([]);
    
    const data = sheet.getDataRange().getValues();
    const customers = [];
    for (let i = 1; i < data.length; i++) {
      customers.push({
        nama: data[i][1] || '',
        no_hp: data[i][2] || '',
        catatan: data[i][3] || '',
        email: data[i][4] || '',
        alamat: data[i][5] || '',
        timestamp: data[i][0] ? data[i][0].toString() : ''
      });
    }
    return jsonResponse(customers);
    
  } catch (error) {
    return jsonResponse({ error: error.message });
  }
}

// ========== GET CARDS ==========
function getCards() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('cards');
    if (!sheet || sheet.getLastRow() <= 1) return jsonResponse([]);
    
    const data = sheet.getDataRange().getValues();
    const cards = [];
    for (let i = 1; i < data.length; i++) {
      cards.push({
        timestamp: data[i][0] ? data[i][0].toString() : '',
        nama_penerima: data[i][1] || '',
        no_hp: data[i][2] || '',
        tema: data[i][3] || '',
        pesan: data[i][4] || '',
        link: data[i][5] || '',
        media_url: data[i][6] || '',
        status: data[i][7] || '',
        message_id: data[i][11] || '',
        expiry_setting: data[i][12] || '90'
      });
    }
    return jsonResponse(cards);
    
  } catch (error) {
    return jsonResponse({ error: error.message });
  }
}

// ========== GET STATS ==========
function getStats() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // Get total messages count
    const messagesSheet = ss.getSheetByName('messages');
    const totalMessages = messagesSheet ? Math.max(0, messagesSheet.getLastRow() - 1) : 0;
    
    // Get expired messages count (excluding permanent)
    let expiredCount = 0;
    if (messagesSheet && messagesSheet.getLastRow() > 1) {
      const data = messagesSheet.getDataRange().getValues();
      const now = new Date();
      for (let i = 1; i < data.length; i++) {
        const expirySetting = data[i][8] || '90';
        if (expirySetting !== 'never') {
          const expires = new Date(data[i][5]);
          if (expires < now) expiredCount++;
        }
      }
    }
    
    // Get customers count
    const customersSheet = ss.getSheetByName('customers');
    const totalCustomers = customersSheet ? Math.max(0, customersSheet.getLastRow() - 1) : 0;
    
    // Get cards count
    const cardsSheet = ss.getSheetByName('cards');
    const totalCards = cardsSheet ? Math.max(0, cardsSheet.getLastRow() - 1) : 0;
    
    return jsonResponse({
      status: 'success',
      total_messages: totalMessages,
      expired_messages: expiredCount,
      active_messages: totalMessages - expiredCount,
      total_customers: totalCustomers,
      total_cards: totalCards
    });
    
  } catch (error) {
    return jsonResponse({ status: 'error', message: error.message });
  }
}

// ========== CLEANUP EXPIRED MESSAGES ==========
function cleanupExpiredMessages() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('messages');
    if (!sheet || sheet.getLastRow() <= 1) return 0;
    
    const data = sheet.getDataRange().getValues();
    const now = new Date();
    const rowsToDelete = [];
    
    for (let i = data.length - 1; i >= 1; i--) {
      const expirySetting = data[i][8] || '90';
      // Only delete non-permanent expired messages
      if (expirySetting !== 'never') {
        const expires = new Date(data[i][5]);
        if (expires < now) {
          rowsToDelete.push(i + 1);
        }
      }
    }
    
    // Delete expired rows (from bottom to top)
    for (let i = rowsToDelete.length - 1; i >= 0; i--) {
      sheet.deleteRow(rowsToDelete[i]);
    }
    
    console.log(`üßπ Cleaned up ${rowsToDelete.length} expired messages`);
    return rowsToDelete.length;
    
  } catch (error) {
    console.error('Cleanup error:', error.message);
    return 0;
  }
}

// ========== GENERATE ID ==========
function generateId() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let id = '';
  for (let i = 0; i < 8; i++) {
    id += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return id;
}

// ========== JSON RESPONSE ==========
function jsonResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// ========== FORCE SETUP ==========
function forceSetup() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // Hapus sheet lama
    ['customers', 'cards', 'messages'].forEach(name => {
      const sheet = ss.getSheetByName(name);
      if (sheet) ss.deleteSheet(sheet);
    });
    
    // Buat sheet baru
    const cust = ss.insertSheet('customers');
    cust.getRange(1,1,1,8).setValues([[
      'Timestamp', 'Nama', 'No_HP', 'Catatan', 'Email', 'Alamat', 'Tgl_Daftar', 'Status'
    ]]).setFontWeight('bold');
    cust.setFrozenRows(1);
    
    const cards = ss.insertSheet('cards');
    cards.getRange(1,1,1,13).setValues([[
      'Timestamp', 'Nama_Penerima', 'No_HP', 'Tema', 'Pesan', 'Link', 'Media_URL',
      'Status', 'WhatsApp_Sent', 'Views', 'Creator', 'Message_ID', 'Expiry_Setting'
    ]]).setFontWeight('bold');
    cards.setFrozenRows(1);
    
    const messages = ss.insertSheet('messages');
    messages.getRange(1,1,1,9).setValues([[
      'ID', 'Message', 'Nama_Penerima', 'No_HP', 'Timestamp', 'Expires', 'Expiry_Days', 'Status', 'Expiry_Setting'
    ]]).setFontWeight('bold');
    messages.setFrozenRows(1);
    
    return '‚úÖ Spreadsheet siap dengan per-card expiry system!';
    
  } catch (error) {
    return '‚ùå Error: ' + error.message;
  }
}

// ========== ON OPEN ==========
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('üé¥ FIOR Card')
    .addItem('üî• Force Setup', 'forceSetup')
    .addItem('üßπ Cleanup Expired', 'cleanupExpiredMessages')
    .addToUi();
}
